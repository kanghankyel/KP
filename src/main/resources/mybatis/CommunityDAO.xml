<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kidsplace.kidsplace.dao.CommunityDAO">

    <resultMap id="noticeMap" type="com.kidsplace.kidsplace.commons.NoticeVO">
        <result property="nNum" column="nNum" />
        <result property="nCategory" column="nCategory" />
        <result property="nWriter" column="nWriter" />
        <result property="nTitle" column="nTitle" />
        <result property="nContent" column="nContent" />
        <result property="nDate" column="nDate" />
        <result property="nDelete" column="nDelete" />
    </resultMap>

    <resultMap id="faqMap" type="com.kidsplace.kidsplace.commons.FaqVO">
        <result property="fNum" column="fNum" />
        <result property="uNum" column="uNum" />
        <result property="fTitle" column="fTitle" />
        <result property="fContent" column="fContent" />
        <result property="fDate" column="fDate" />
        <result property="fUpdate" column="fUpdate" />
        <result property="fDeleteDate" column="fDeleteDate" />
        <result property="fDelete" column="fDelete" />
    </resultMap>

    <sql id="noticeSearch">
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(noticeVO.nNum)">
            AND nNum LIKE '%' + #{ticketVO.nNum} + '%'
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(noticeVO.nCategory)">
            AND nCategory LIKE '%' + #{ticketVO.nCategory} + '%'
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(noticeVO.nWriter)">
            AND nWriter LIKE '%' + #{ticketVO.nWriter} + '%'
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(noticeVO.nTitle)">
            AND nTitle LIKE '%' + #{ticketVO.nTitle} + '%'
        </if>
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(noticeVO.nContent)">
            AND nContent LIKE '%' + #{ticketVO.nContent} + '%'
        </if>
    </sql>

    <!--  공지사항 리스트 불러오기  -->
    <!-- <select id="noticeList" resultMap="noticeMap">
        SELECT
            nNum,nCategory,nWriter,nTitle,nContent,date_format(nDate, '%Y-%m-%d') AS nDate,nDelete
        FROM
            kidslandNotice
        WHERE
            nDelete = 'N'
        ORDER BY
            nNum;
    </select> -->

    <!-- 공지사항 리스트 페이징 -->
    <select id="noticePaging" resultMap="noticeMap">
        SELECT
            nNum
           ,nCategory
           ,nWriter
           ,nTitle
           ,nContent
           ,date_format(nDate, '%Y-%m-%d') AS nDate
           ,nDelete
        FROM
            kidslandNotice
        WHERE
            nDelete = 'N'
            <!-- <include refid="noticeSearch" /> -->
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(noticeVO.nCategory)">
                AND nCategory LIKE CONCAT('%', #{noticeVO.nCategory}, '%')
            </if>
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(noticeVO.nTitle)">
                AND nTitle LIKE CONCAT('%', #{noticeVO.nTitle}, '%')
            </if>
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(noticeVO.nContent)">
                AND nContent LIKE CONCAT('%', #{noticeVO.nContent}, '%')
            </if>
        ORDER BY
            nNum DESC
        LIMIT
            #{pagination.limitStart}, #{pagination.recordSize}
    </select>

    <!-- 공지사항 리스트 카운팅 -->
    <select id="noticeCount" resultType="int">
        SELECT
            count(*)
        FROM
            kidslandNotice
        WHERE
            nDelete = 'N'
            <!-- <include refid="noticeSearch" /> -->
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(noticeVO.nCategory)">
                AND nCategory LIKE CONCAT('%', #{noticeVO.nCategory}, '%')
            </if>
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(noticeVO.nTitle)">
                AND nTitle LIKE CONCAT('%', #{noticeVO.nTitle}, '%')
            </if>
            <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(noticeVO.nContent)">
                AND nContent LIKE CONCAT('%', #{noticeVO.nContent}, '%')
            </if>
    </select>

    <!--  공지사항 해당 항목 불러오기  -->
    <select id="noticeRead" resultMap="noticeMap">
        SELECT
            nNum,nCategory,nWriter,nTitle,nContent,date_format(nDate, '%Y/%m/%d') AS nDate,nDelete
        FROM
            kidslandNotice
        WHERE
            nDelete = 'N'
        AND
            nNum = #{nNum, jdbcType=VARCHAR}
    </select>

    <!-- 공지사항 작성 -->
    <insert id="noticeWrite">
        INSERT INTO
            kidslandNotice(nNum, nCategory, nWriter, nTitle, nContent)
        VALUES
            ((SELECT resultTable.resultNum FROM (SELECT IFNULL(MAX(nNum), 0) + 1 AS resultNum FROM kidslandNotice) resultTable)
            , #{nCategory}
            , #{nWriter}
            , #{nTitle}
            , #{nContent})
    </insert>

    <!-- 공지사항 수정 -->
    <update id="noticeEdit">
        UPDATE
            kidslandNotice
        SET
            nCategory = #{nCategory}
          , nWriter = #{nWriter}
          , nTitle = #{nTitle}
          , nContent = #{nContent}
          , nDate = CURRENT_TIMESTAMP
        WHERE
            nNum = #{nNum}
    </update>

    <!-- 공지사항 삭제 -->
    <update id="noticeDelete">
        UPDATE
            kidslandNotice
        SET
            nDelete = 'Y'
        WHERE
            nNum = #{nNum}
    </update>

    <!-- FAQ 리스트 페이징 -->
    <select id="faqPaging" resultMap="faqMap">
        SELECT
            fNum
           ,uNum
           ,fTitle
           ,fContent
           ,fDate
           ,fUpdate
           ,fDeleteDate
           ,fDelete
        FROM
            kidslandFaq
        WHERE
            fDelete = 'N'
        ORDER BY
            fNum DESC
        LIMIT
            #{pagination.limitStart}, #{pagination.recordSize}
    </select>

    <!-- FAQ 게시글 카운팅 -->
    <select id="faqCount" resultType="int">
        SELECT
            count(*)
        FROM
            kidslandFaq
        WHERE
            fDelete = 'N'
    </select>

    <!-- FAQ 쓰기 -->
    <insert id="faqWrite">
        INSERT INTO
            kidslandFaq(fNum, uNum, fTitle, fContent)
        VALUES
            ((SELECT resultTable.resultNum FROM (SELECT IFNULL(MAX(fNum), 0) + 1 AS resultNum FROM kidslandFaq) resultTable)
            , #{uNum}
            , #{fTitle}
            , #{fContent})
    </insert>
    
    <!-- FAQ 삭제 -->
    <update id="faqDelete">
        UPDATE
            kidslandFaq
        SET
            fDelete = 'Y'
        WHERE
            fNum = #{fNum}
    </update>

    <!-- 사내공지사항 -->

    <!-- 고객공지사항 -->
    <select id="adminNotice" resultMap="noticeMap">
        SELECT
            nNum
           ,nTitle
           ,date_format(nDate, '%Y.%m.%d') AS nDate
        FROM
            kidslandNotice
        WHERE
            nDelete = 'N'
        ORDER BY
            nNum DESC
        LIMIT
            6
    </select>
</mapper>